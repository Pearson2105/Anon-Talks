<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Anon Login</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>

<!-- SAME HEADER AS index.html -->
<header>
    <div class="username">Welcome</div>
    <div class="center title-text">Anon-Talks</div>
</header>

<div class="setup-box">
    <h1 class="title-text" style="font-size:40px; margin-top:-10px;">Anon-Talks</h1>
    <p>Choose how you want to continue:</p>

    <button id="loginBtn" class="big-btn">Login</button>
    <button id="generateBtn" class="big-btn purple">Generate Identity</button>
</div>

<!-- LOGIN POPUP -->
<div id="loginPopup" class="popup-overlay">
    <div class="popup-box">
        <h2>Login</h2>

        <label>Username:</label>
        <input id="loginUser">

        <label>Password:</label>
        <input id="loginPass" type="password">

        <div id="loginError" style="color:red; display:none;">Invalid login.</div>

        <button id="loginConfirm">Login</button>
        <button onclick="closeLogin()">Cancel</button>
    </div>
</div>

<!-- GENERATE POPUP -->
<div id="generatePopup" class="popup-overlay">
    <div class="popup-box">
        <h2>Your Anonymous Identity</h2>

        <p><strong>Username:</strong> <span id="genUser"></span></p>
        <p><strong>Password:</strong> <span id="genPass"></span></p>

        <button id="useIdentity">Use This Identity</button>
        <button onclick="closeGenerate()">Cancel</button>
    </div>
</div>

<script>
/* -------------------------
        OPEN / CLOSE POPUPS
--------------------------*/
const loginPopup = document.getElementById("loginPopup");
const generatePopup = document.getElementById("generatePopup");

document.getElementById("loginBtn").onclick = () => loginPopup.style.display = "flex";
document.getElementById("generateBtn").onclick = fetchGeneratedIdentity;

function closeLogin() { loginPopup.style.display = "none"; }
function closeGenerate() { generatePopup.style.display = "none"; }

/* -------------------------
       LOGIN HANDLING
--------------------------*/
document.getElementById("loginConfirm").onclick = async () => {
    const username = document.getElementById("loginUser").value;
    const password = document.getElementById("loginPass").value;

    const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    });

    const data = await res.json();

    if (data.success) {
        localStorage.setItem("anon_username", username);
        localStorage.setItem("anon_password", password);
        window.location.href = "/";
    } else {
        document.getElementById("loginError").style.display = "block";
    }
};

/* -------------------------
 GENERATE UNIQUE IDENTITY
--------------------------*/
async function fetchGeneratedIdentity() {
    const res = await fetch("/api/generate", {
        method: "POST"
    });

    const data = await res.json();

    document.getElementById("genUser").innerText = data.username;
    document.getElementById("genPass").innerText = data.password;

    generatePopup.style.display = "flex";

    document.getElementById("useIdentity").onclick = () => {
        localStorage.setItem("anon_username", data.username);
        localStorage.setItem("anon_password", data.password);
        window.location.href = "/";
    };
}
</script>

</body>
</html>
